#!/bin/python

from astropy.io import fits
from astropy.table import Table, vstack
import argparse
import numpy
import glob
import sys

parser = argparse.ArgumentParser(description="Script to merge dithering_signals outputs")
parser.add_argument("-p", "--prefix", 
                    required=True)
parser.add_argument("-s", "--seeing", 
                    required=False,
                    default=0.1)
parser.add_argument('-t', '--template',
                    required=False,
                    default='template1')
parser.add_argument('-a', '--pattern',
                    required=False,
                    default='triangle')
parser.add_argument('-d', '--dithers',
                    default=10)
parsed_args = parser.parse_args()

folder_list  = glob.glob("{}/*um".format(parsed_args.prefix))
search_radii = [folder_name.split("um")[0] for folder_name in folder_list] # not needed. remove next time

for folder in folder_list:
    print("running for folder {}".format(folder))
    files = glob.glob("{}/result_{}_dithers{}_seeing{}_*-*offset*_*_template{}.fits".format(folder, parsed_args.pattern, parsed_args.dithers, parsed_args.seeing, parsed_args.template, parsed_args.template))
    print(files)
    print("{}/result_{}_dithers{}_seeing{}_*-*offset*_*_template{}.fits".format(folder, parsed_args.pattern, parsed_args.dithers, parsed_args.seeing, parsed_args.template, parsed_args.template))
    if len(files) < 9:# or len(files) != 10: 
        print("there is a problem with the given set of arguments for {}".format(folder))
        print(len(files))
        continue
    hdus  = fits.open(files[0])
    table = Table(hdus[1].data)
    hdus.close()
    for filename in files[1:]:
        hdus = fits.open(filename)
        table_to_add = Table(hdus[1].data)
        table = vstack([table, table_to_add])
        hdus.close()
    new_filename = "_".join(files[0].split("_")[:-2])+"_combined_"+files[0].split("_")[-1]
    print("merging files into: {}".format(new_filename))
    #table.write(new_filename, format="fits")
    break
    #import time
    #time.sleep(120)
